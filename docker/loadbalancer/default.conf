server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name _;
    root /var/www/streams;
    index index.html;

    # CORS headers for Flutter apps
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization" always;

    # Security headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # HLS streaming configuration
    location ~ \.m3u8$ {
        types {
            application/vnd.apple.mpegurl m3u8;
        }
        add_header Cache-Control "no-cache" always;
        add_header Access-Control-Allow-Origin * always;
        expires -1;
    }

    location ~ \.ts$ {
        types {
            video/mp2t ts;
        }
        add_header Cache-Control "max-age=3600" always;
        add_header Access-Control-Allow-Origin * always;
        expires 1h;
    }

    # MP4 streaming
    location ~ \.mp4$ {
        mp4;
        mp4_buffer_size 5M;
        mp4_max_buffer_size 10M;
        add_header Cache-Control "max-age=7200" always;
        add_header Access-Control-Allow-Origin * always;
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Status endpoint for monitoring
    location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        allow 172.16.0.0/12;  # Docker networks
        deny all;
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Handle 404 errors
    error_page 404 /404.html;
    location = /404.html {
        internal;
    }

    # Handle 50x errors
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        internal;
    }
}
